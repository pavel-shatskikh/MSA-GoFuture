# Примечание

Не очень понял в чем смысл задачи - выбора региона размещения, так как сами регионы уже выбраны по условию.
Наверное имелось в виду целевые точки размещения в самих (выбранных) регионах.
Плюс в курсе не было информации про глобальное развертывание, поэтому тут пример на основе внешних источников (включая
схему failover).

# Выбора регионов развертывания

- Юго-Восточная Азия (SEA), Сингапур: минимальная задержка по ЮВА, зрелая сетка дата-центров, стабильная межоператорская
  связность.
- Южная Америка (SA), Сан-Паулу: низкая RTT для Бразилии/Южной Америки, соответствие LGPD.
- Европа (EU), Франкфурт/Нидерланды: строгий комплаенс (GDPR), хороший «хаб» для бэкапов и кросс-региональных задач.

# Схема репликации данных (multi-region)

## Kafka (события)

- Отдельный кластер на регион: eu.*, sea.*, sa.*.
- Cluster Linking/MM2 - выборочная репликация (факты/справочники) в соседние регионы.
- Retry/DLQ - только регионально, чтобы не усложнять.

## PostgreSQL

- Кросс-региональная: логическая репликация/CDC на уровне доменных сущностей. Single-writer на регион, компенсации -
  через саги.

## Elasticsearch (Geo/поиск)

- Региональные индексы, в соседних регионах - CCR followers (read-only).

## Redis (кэш/сессии)

- Только регионально, чтобы не усложнять и не терять в скорости.

## S3 Storage

- CRR между EU/SEA/SA, ключи на каждый регион.

## ClickHouse (OLAP)

Репликация по регионам из региональных Kafka, распределенные таблицы для кросс-региональных запросов (должно
быть не критично).

## Гео-маршрутизация к ближайшему региону

- Region-pinning: добавляем claim region прямо в JWT, API-Gateway соблюдает привязку и балансировку, fallback - через
  GeoDNS при инцидентах.

# Шаги

## Общее

1. Edge снимает проблемный регион из ротации (GeoDNS HC) и трафик уходит в соседний регион.
2. Kafka: потребители поднимаются на linked-топики или локальные продьюсеры продолжают писать в свой регион + ретраи.
3. OLTP: для Payments - для оплат скорее всего возможности компенсации нет, деградация.
4. Кэши: cash-miss нормальная ситуация, влияния нет.
5. Саги: тайм-ауты, компенсации, идемпотентность ключей.

## Сценарии

| Сценарий                | Детектор              | Автодействие                                     | Переключение                                              | Влияние                         |
|-------------------------|-----------------------|--------------------------------------------------|-----------------------------------------------------------|---------------------------------|
| Проблемы внутри региона | NLB HC, k8s readiness | Рестарты внутри кластера                         | Внутри региона                                            | Незначительные пики латентности |
| Падение региона         | GeoDNS HC, SLO        | Вывод региона из ротации                         | На соседний регион                                        | Краткосрочный рост латентности  |
| Проблемы с Kafka        | Метрики               | Throttle producers                               | Остаться в регионе; при необходимости чтение из соседнего | Умеренный лаг событий           |
| Отказ оплаты            | Метрики               | Пробуем переключить оплату через соседний регион | Переключение webhooks, ключей                             | Короткая деградация CRUD        |
| Сбой Schema Registry    | SR HC, 5xx            | Фолбэк на cache, freeze deploy                   | Без переезда                                              | Риск схем - снижена строгость   |
| Атака на edge           | Пробы                 | Включение «жёстких» правил WAF                   | Альт. edge / соседний регион                              | Временное ограничение фич       |
